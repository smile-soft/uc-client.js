!function(e,t,o){var n=t.SmileSoft=t.SmileSoft||function(){var e={},t=e.hasOwnProperty;return{on:function(o,n){t.call(e,o)||(e[o]=[]);var r=e[o].push(n)-1;return{remove:function(){delete e[o][r]}}},emit:function(o,n){t.call(e,o)&&e[o].forEach(function(e){e(void 0!=n?n:{})})}}}();n[e]=o(e,n)}("Client",this,function(e,t){"use strict";function o(o,n){t.on(e+"."+S[o],function(e){n(e)})}function n(o,n){t.emit(e+"."+S[o],n)}function r(e,t){var o=Object.create(e);return Object.keys(t).map(function(e){e in o&&(o[e]=t[e])}),o}function s(e){var t=1e3*(Math.pow(2,e)-1);return t>3e4&&(t=3e4),Math.random()*t}function i(){}function c(){console.log("Websocket opened"),n("moduleInitiated")}function a(o){var n=JSON.parse(o.data),r=n.method;if(console.log("onWebsocketMessage data: ",n),n.error&&t.emit("Error",{module:e,error:n.error}),n.method){var s=n.params;"incomingCall"==r?w(s):"stateChanged"==r&&m(s)}else n.id&&callbackOnId(n.id,n.result)}function l(){if(console.log("Websocket closed"),k.websockets){var e=s(M);setTimeout(function(){M++,d()},e)}}function u(o){t.emit("Error",{module:e,error:o})}function d(){if(k.websockets){if(!window.WebSocket)return console.log("WebSocket is not supported. Please update your browser."),console.log("Fallback to XMLHttpRequest"),k.websockets=!1,d();console.log("Switched to Websockets"),void 0!==h&&clearInterval(h),g=new WebSocket(("https"===C?"wss":"ws")+"://"+k.server+"/","json.api.smile-soft.com"),g.onopen=c,g.onmessage=a,g.onclose=l,g.onerror=u}else void 0!==g&&g.close(),console.log("Switched to XMLHttpRequest"),i(),n("moduleInitiated")}function f(){return window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")}function p(o,n,r){var s,i,c,a={},l=null;a.method=o,n&&(a.params=n),"number"==typeof r&&(a.id=r),a=JSON.stringify(a),k.websockets?g.send(a):(s=f(),s.open("POST",C+"://"+k.server+"/",!0),c=setTimeout(function(){s.abort()},3e4),s.onreadystatechange=function(){4==s.readyState&&(clearTimeout(c),s.response&&(i=JSON.parse(s.response),i.error&&(l=i.error,t.emit("Error",{module:e,error:l})),r&&r(i.result)))},s.setRequestHeader("Content-Type","application/json; charset=UTF-8"),s.send(a))}function m(e){n("stateChange",e)}function w(e){n("incomingCall",e)}function b(t){return t&&(k=r(k,t)),O?console.log("Module "+e+" already initiated, do nothing"):(d(),O=!0,v)}var h,g,v,k={server:window.location.host,websockets:!0,updateInterval:1e3},S={moduleInitiated:"moduleInitiated",incomingCall:"incomingcall",stateChange:"statechange"},C=-1!==window.location.protocol.indexOf("https")?"https":"http",M=1,O=!1;return v={process:{},state:null,substate:null,getState:function(){p("getState",null,k.websockets?5:m)},call:function(e){p("initCall",{number:e})},answer:function(){p("answerCall")},hold:function(){p("pressHold")},conference:function(){p("pressConference")},drop:function(){p("dropCall")}},o("statechange",function(e){v.state=e.state,v.substate=e.substate}),b});